# 学校時間割システム 単体テスト仕様書 v2.0

## 概要

型安全化改修後の学校時間割システムの包括的単体テスト仕様書です。全分岐網羅カバレッジ100%を基準とした、プロフェッショナルレベルのテスト仕様を定義します。

### テスト対象範囲

1. **型安全フロントエンドコンポーネント**
   - TeachersSection.tsx
   - SubjectsSection.tsx  
   - ClassroomsSection.tsx

2. **型安全カスタムフック**
   - use-teacher-api.ts
   - use-subject-api.ts

3. **統合型安全バックエンドAPI**
   - /api/* エンドポイント
   - /api/safe/* エンドポイント

4. **型安全サービス層**
   - TypeSafeSchoolService
   - TypeSafeTimetableGenerationEngine
   - TypeSafeDbHelper

5. **Zodスキーマ検証**
   - shared/schemas.ts

## 1. フロントエンドコンポーネント単体テスト仕様

### 1.1 TeachersSection コンポーネント

#### テスト環境セットアップ
```typescript
describe('TeachersSection', () => {
  const mockProps = {
    teachers: mockTeachersData,
    onTeachersUpdate: jest.fn(),
    token: 'test-token',
    getFreshToken: jest.fn(),
    isLoading: false
  }
  
  beforeEach(() => {
    jest.clearAllMocks()
    // 統合APIのモック設定
  })
})
```

#### 1.1.1 レンダリング系テスト（カバレッジ目標: 100%）

**TC-FE-TS-001: 初期レンダリング**
- **目的**: コンポーネントが正常にレンダリングされることを確認
- **前提条件**: teachers配列が空でない
- **実行手順**:
  1. TeachersSectionコンポーネントをレンダリング
  2. ヘッダー「教師情報管理」が表示されることを確認
  3. 「教師を追加」ボタンが表示されることを確認
  4. テーブルヘッダーが正しく表示されることを確認
- **期待結果**: 全要素が正常に表示される
- **分岐カバレッジ**: isLoading=false分岐

**TC-FE-TS-002: ローディング状態レンダリング**
- **目的**: ローディング中の表示を確認
- **前提条件**: isLoading=true
- **実行手順**:
  1. isLoading=trueでコンポーネントをレンダリング
  2. ローディングスピナーが表示されることを確認
  3. 「読み込み中...」テキストが表示されることを確認
- **期待結果**: ローディング表示が正常に表示される
- **分岐カバレッジ**: isLoading=true分岐

**TC-FE-TS-003: 空のteachers配列でのレンダリング**
- **目的**: 教師データが空の場合の表示を確認
- **前提条件**: teachers=[]
- **実行手順**:
  1. 空のteachers配列でコンポーネントをレンダリング
  2. 「教師情報が登録されていません」メッセージが表示されることを確認
- **期待結果**: 空状態メッセージが表示される
- **分岐カバレッジ**: teachers.length === 0分岐

**TC-FE-TS-004: 無効なteachers配列でのレンダリング**
- **目的**: teachersが配列でない場合の表示を確認
- **前提条件**: teachers=null または undefined
- **実行手順**:
  1. 無効なteachers値でコンポーネントをレンダリング
  2. エラーメッセージまたは空状態が表示されることを確認
- **期待結果**: 適切なフォールバック表示
- **分岐カバレッジ**: !Array.isArray(teachers)分岐

#### 1.1.2 教師データ表示テスト

**TC-FE-TS-005: 教師情報正常表示**
- **目的**: 教師の基本情報が正しく表示されることを確認
- **前提条件**: 完全な教師データ
- **実行手順**:
  1. 教師名が表示されることを確認
  2. 担当科目がBadgeで表示されることを確認
  3. 担当学年がBadgeで表示されることを確認
  4. 割当制限情報が表示されることを確認
- **期待結果**: 全情報が正しくフォーマットされて表示
- **分岐カバレッジ**: 全表示ロジック分岐

**TC-FE-TS-006: 教師の担当科目が空の場合**
- **目的**: 担当科目が空の場合の表示を確認
- **前提条件**: teacher.subjects = []
- **実行手順**:
  1. 担当科目セクションで「科目なし」が表示されることを確認
- **期待結果**: 「科目なし」表示
- **分岐カバレッジ**: subjectsArray.length === 0分岐

**TC-FE-TS-007: 教師の担当学年が空の場合**
- **目的**: 担当学年が空の場合の表示を確認  
- **前提条件**: teacher.grades = []
- **実行手順**:
  1. 担当学年セクションが空で表示されることを確認
- **期待結果**: 学年情報なし状態
- **分岐カバレッジ**: grades配列空分岐

**TC-FE-TS-008: 割当制限情報の表示**
- **目的**: 割当制限の有無による表示切り替えを確認
- **前提条件**: assignmentRestrictions配列の有無
- **実行手順**:
  1. 制限ありの場合「割当制限あり」が表示されることを確認
  2. 制限なしの場合「割当制限なし」が表示されることを確認
- **期待結果**: 制限状態による適切な表示
- **分岐カバレッジ**: restrictions.length分岐

#### 1.1.3 イベントハンドリングテスト

**TC-FE-TS-009: 教師追加ボタンクリック**
- **目的**: 新規教師追加の開始を確認
- **前提条件**: ボタンが有効状態
- **実行手順**:
  1. 「教師を追加」ボタンをクリック
  2. editingTeacher が null に設定されることを確認
  3. isDialogOpen が true に設定されることを確認
- **期待結果**: 新規追加ダイアログが開く
- **分岐カバレッジ**: handleAddTeacher実行分岐

**TC-FE-TS-010: 教師編集ボタンクリック**
- **目的**: 教師編集の開始を確認
- **前提条件**: 既存教師データ
- **実行手順**:
  1. 特定教師の編集ボタンをクリック
  2. editingTeacher に対象教師が設定されることを確認
  3. isDialogOpen が true に設定されることを確認
- **期待結果**: 編集ダイアログが開く
- **分岐カバレッジ**: handleEditTeacher実行分岐

**TC-FE-TS-011: 教師削除ボタンクリック（成功）**
- **目的**: 教師削除処理の成功ケースを確認
- **前提条件**: 有効なtoken、既存教師ID
- **実行手順**:
  1. 教師の削除ボタンをクリック
  2. apiV2.teachers.deleteTeacherが呼び出されることを確認
  3. onTeachersUpdateが適切なデータで呼び出されることを確認
  4. 成功トーストが表示されることを確認
- **期待結果**: 教師が削除され、UIが更新される
- **分岐カバレッジ**: 削除成功分岐

**TC-FE-TS-012: 教師削除ボタンクリック（バリデーションエラー）**
- **目的**: 削除時のバリデーションエラー処理を確認
- **前提条件**: apiV2がバリデーションエラーを返す
- **実行手順**:
  1. 教師の削除ボタンをクリック
  2. apiV2.isValidationError(error)がtrueを返すことを確認
  3. バリデーションエラー用のトーストが表示されることを確認
- **期待結果**: バリデーションエラーメッセージが表示
- **分岐カバレッジ**: isValidationError(error)分岐

**TC-FE-TS-013: 教師削除ボタンクリック（一般エラー）**
- **目的**: 削除時の一般エラー処理を確認
- **前提条件**: apiV2が一般エラーを返す
- **実行手順**:
  1. 教師の削除ボタンをクリック
  2. 一般エラー用のトーストが表示されることを確認
- **期待結果**: 一般エラーメッセージが表示
- **分岐カバレッジ**: 一般エラー分岐

**TC-FE-TS-014: tokenなしでの削除試行**
- **目的**: tokenがない場合の削除処理を確認
- **前提条件**: token = null
- **実行手順**:
  1. 教師の削除ボタンをクリック
  2. API呼び出しが実行されないことを確認
- **期待結果**: 削除処理が実行されない
- **分岐カバレッジ**: !token分岐

#### 1.1.4 一括保存機能テスト

**TC-FE-TS-015: 全教師情報保存（成功）**
- **目的**: 全教師の一括保存成功ケースを確認
- **前提条件**: 有効なtoken、教師データ
- **実行手順**:
  1. 「教師情報を保存」ボタンをクリック
  2. 各教師のupdateTeacherが呼び出されることを確認
  3. 成功トーストが表示されることを確認
- **期待結果**: 全教師が保存される
- **分岐カバレッジ**: failCount === 0分岐

**TC-FE-TS-016: 全教師情報保存（部分失敗）**
- **目的**: 一部教師の保存が失敗した場合を確認
- **前提条件**: 一部のupdateTeacher呼び出しが失敗
- **実行手順**:
  1. 「教師情報を保存」ボタンをクリック
  2. 部分失敗トーストが表示されることを確認
- **期待結果**: 部分失敗メッセージが表示
- **分岐カバレッジ**: failCount > 0分岐

**TC-FE-TS-017: 全教師情報保存（エラー）**
- **目的**: 保存処理全体でエラーが発生した場合を確認
- **前提条件**: Promise.allSettledでエラー
- **実行手順**:
  1. 「教師情報を保存」ボタンをクリック
  2. エラートーストが表示されることを確認
- **期待結果**: エラーメッセージが表示
- **分岐カバレッジ**: catch分岐

#### 1.1.5 ドラッグ&ドロップ機能テスト

**TC-FE-TS-018: 教師順序変更（成功）**
- **目的**: 教師の順序変更処理を確認
- **前提条件**: 複数の教師データ
- **実行手順**:
  1. 教師をドラッグ&ドロップで順序変更
  2. onTeachersUpdateが新しい順序で呼び出されることを確認
  3. デバウンス処理後にAPIが呼び出されることを確認
  4. 順序保存完了トーストが表示されることを確認
- **期待結果**: 順序が変更され保存される
- **分岐カバレッジ**: ドラッグ成功分岐

**TC-FE-TS-019: 教師順序変更（同じ位置）**
- **目的**: 同じ位置へのドロップ処理を確認
- **前提条件**: active.id === over?.id
- **実行手順**:
  1. 教師を同じ位置にドロップ
  2. 順序変更処理が実行されないことを確認
- **期待結果**: 変更処理がスキップされる
- **分岐カバレッジ**: active.id === over?.id分岐

**TC-FE-TS-020: 順序保存エラー**
- **目的**: 順序保存時のエラー処理を確認
- **前提条件**: updateTeacher APIがエラーを返す
- **実行手順**:
  1. 教師の順序を変更
  2. エラートーストが表示されることを確認
- **期待結果**: エラーメッセージが表示
- **分岐カバレッジ**: 順序保存エラー分岐

#### 1.1.6 データ正規化テスト

**TC-FE-TS-021: 教師データ正規化（subjects文字列）**
- **目的**: subjects文字列の正規化を確認
- **前提条件**: teacher.subjects = "[\"数学\",\"物理\"]"
- **実行手順**:
  1. コンポーネントをレンダリング
  2. 正規化された担当科目が表示されることを確認
- **期待結果**: JSON文字列が配列として表示
- **分岐カバレッジ**: typeof teacher.subjects === 'string'分岐

**TC-FE-TS-022: 教師データ正規化（subjects配列）**
- **目的**: subjects配列の正規化を確認
- **前提条件**: teacher.subjects = ["数学", "物理"]
- **実行手順**:
  1. コンポーネントをレンダリング
  2. 担当科目が配列として表示されることを確認
- **期待結果**: 配列がそのまま表示
- **分岐カバレッジ**: Array.isArray(teacher.subjects)分岐

**TC-FE-TS-023: 教師データ正規化（無効なJSON）**
- **目的**: 無効なJSON文字列の処理を確認
- **前提条件**: teacher.subjects = "invalid json"
- **実行手順**:
  1. コンポーネントをレンダリング
  2. 空配列にフォールバックされることを確認
- **期待結果**: エラーなく空配列として処理
- **分岐カバレッジ**: JSON.parse catch分岐

### 1.2 SubjectsSection コンポーネント

#### テスト環境セットアップ
```typescript
describe('SubjectsSection', () => {
  const mockProps = {
    token: 'test-token',
    getFreshToken: jest.fn()
  }
  
  beforeEach(() => {
    jest.clearAllMocks()
    // apiV2とsubjectApiのモック設定
  })
})
```

#### 1.2.1 データ読み込みテスト

**TC-FE-SS-001: 教科データ初期読み込み（成功）**
- **目的**: 教科データの正常な読み込みを確認
- **前提条件**: 有効なtoken、API正常応答
- **実行手順**:
  1. コンポーネントをマウント
  2. apiV2.subjects.getSubjectsが呼び出されることを確認
  3. 取得した教科データが状態に設定されることを確認
  4. ローディング状態が解除されることを確認
- **期待結果**: 教科データが正常に読み込まれる
- **分岐カバレッジ**: 読み込み成功分岐

**TC-FE-SS-002: 教科データ読み込み（APIエラー）**
- **目的**: API エラー時の処理を確認
- **前提条件**: apiV2.subjects.getSubjectsがエラーを返す
- **実行手順**:
  1. コンポーネントをマウント
  2. エラーがコンソールに出力されることを確認
  3. 空配列が設定されることを確認
  4. ローディング状態が解除されることを確認
- **期待結果**: エラー処理が適切に実行される
- **分岐カバレッジ**: catch分岐

**TC-FE-SS-003: 教科データ読み込み（タイムアウト）**
- **目的**: 読み込みタイムアウト処理を確認
- **前提条件**: API応答が15秒以上
- **実行手順**:
  1. コンポーネントをマウント
  2. 15秒後にタイムアウト処理が実行されることを確認
  3. ローディング状態が強制解除されることを確認
- **期待結果**: タイムアウト処理が実行される
- **分岐カバレッジ**: タイムアウト分岐

**TC-FE-SS-004: tokenなしでの読み込み**
- **目的**: tokenがない場合の処理を確認
- **前提条件**: token = null
- **実行手順**:
  1. コンポーネントをマウント
  2. API呼び出しがスキップされることを確認
  3. ローディング状態が解除されることを確認
- **期待結果**: API呼び出しなしで完了
- **分岐カバレッジ**: !token分岐

#### 1.2.2 教科データ表示テスト

**TC-FE-SS-005: 教科情報正常表示**
- **目的**: 教科の基本情報表示を確認
- **前提条件**: 完全な教科データ
- **実行手順**:
  1. 教科名が表示されることを確認
  2. 対象学年がフォーマットされて表示されることを確認
  3. 専用教室情報が表示されることを確認
  4. 週授業数が表示されることを確認
- **期待結果**: 全情報が正しく表示される
- **分岐カバレッジ**: 正常表示分岐

**TC-FE-SS-006: 対象学年フォーマット（正常）**
- **目的**: 対象学年の正常フォーマット処理を確認
- **前提条件**: subject.grades = [1, 2, 3]
- **実行手順**:
  1. formatGrades関数が呼び出されることを確認
  2. "1年, 2年, 3年"形式で表示されることを確認
- **期待結果**: 学年が正しくフォーマットされる
- **分岐カバレッジ**: grades配列正常分岐

**TC-FE-SS-007: 対象学年フォーマット（空配列）**
- **目的**: 空の対象学年配列の処理を確認
- **前提条件**: subject.grades = []
- **実行手順**:
  1. "全学年"が表示されることを確認
- **期待結果**: "全学年"表示
- **分岐カバレッジ**: grades.length === 0分岐

**TC-FE-SS-008: 対象学年フォーマット（エラー）**
- **目的**: grades配列処理でのエラーハンドリング確認
- **前提条件**: 無効なgrades データ
- **実行手順**:
  1. エラーがキャッチされることを確認
  2. "全学年"にフォールバックされることを確認
- **期待結果**: エラー処理で安全にフォールバック
- **分岐カバレッジ**: catch分岐

**TC-FE-SS-009: 専用教室表示（あり）**
- **目的**: 専用教室がある場合の表示を確認
- **前提条件**: subject.specialClassroom = "理科室"
- **実行手順**:
  1. 専用教室名がBadgeで表示されることを確認
- **期待結果**: "理科室"がBadgeで表示
- **分岐カバレッジ**: specialClassroom存在分岐

**TC-FE-SS-010: 専用教室表示（なし）**
- **目的**: 専用教室がない場合の表示を確認
- **前提条件**: subject.specialClassroom = null
- **実行手順**:
  1. "なし"が表示されることを確認
- **期待結果**: "なし"表示
- **分岐カバレッジ**: !specialClassroom分岐

#### 1.2.3 CRUD操作テスト

**TC-FE-SS-011: 教科追加ダイアログ開始**
- **目的**: 新規教科追加の開始を確認
- **前提条件**: ボタンが有効状態
- **実行手順**:
  1. 「教科を追加」ボタンをクリック
  2. editingSubject が null に設定されることを確認
  3. isSubjectDialogOpen が true に設定されることを確認
- **期待結果**: 新規追加ダイアログが開く
- **分岐カバレッジ**: handleAddSubject分岐

**TC-FE-SS-012: 教科編集ダイアログ開始**
- **目的**: 教科編集の開始を確認
- **前提条件**: 既存教科データ
- **実行手順**:
  1. 特定教科の編集ボタンをクリック
  2. editingSubject に対象教科が設定されることを確認
  3. isSubjectDialogOpen が true に設定されることを確認
- **期待結果**: 編集ダイアログが開く
- **分岐カバレッジ**: handleEditSubject分岐

**TC-FE-SS-013: 教科削除（成功）**
- **目的**: 教科削除処理の成功ケースを確認
- **前提条件**: 有効なtoken、既存教科ID
- **実行手順**:
  1. 教科の削除ボタンをクリック
  2. apiV2.subjects.deleteSubjectが呼び出されることを確認
  3. subjects状態から該当教科が除外されることを確認
  4. 成功トーストが表示されることを確認
- **期待結果**: 教科が削除される
- **分岐カバレッジ**: 削除成功分岐

**TC-FE-SS-014: 教科削除（バリデーションエラー）**
- **目的**: 削除時のバリデーションエラー処理を確認
- **前提条件**: apiV2がバリデーションエラーを返す
- **実行手順**:
  1. 教科の削除ボタンをクリック
  2. バリデーションエラー用のトーストが表示されることを確認
- **期待結果**: バリデーションエラーメッセージ表示
- **分岐カバレッジ**: isValidationError分岐

**TC-FE-SS-015: 教科削除（404エラー）**
- **目的**: 教科が既に削除済みの場合の処理確認
- **前提条件**: apiV2が404エラーを返す
- **実行手順**:
  1. 教科の削除ボタンをクリック
  2. 既に削除済みとして処理されることを確認
  3. subjects状態から該当教科が除外されることを確認
- **期待結果**: 既削除として適切に処理
- **分岐カバレッジ**: isNotFoundError分岐

**TC-FE-SS-016: 教科保存（新規作成成功）**
- **目的**: 新規教科作成の成功ケースを確認
- **前提条件**: editingSubject = null、有効な教科データ
- **実行手順**:
  1. ダイアログから教科データを送信
  2. apiV2.subjects.createSubjectが呼び出されることを確認
  3. 新教科がsubjects状態に追加されることを確認
  4. 成功トーストが表示されることを確認
- **期待結果**: 新規教科が作成される
- **分岐カバレッジ**: 新規作成成功分岐

**TC-FE-SS-017: 教科保存（更新成功）**
- **目的**: 教科更新の成功ケースを確認
- **前提条件**: editingSubject存在、有効な教科データ
- **実行手順**:
  1. ダイアログから教科データを送信
  2. apiV2.subjects.updateSubjectが呼び出されることを確認
  3. subjects状態の該当教科が更新されることを確認
  4. 成功トーストが表示されることを確認
- **期待結果**: 教科が更新される
- **分岐カバレッジ**: 更新成功分岐

**TC-FE-SS-018: 教科保存（バリデーションエラー）**
- **目的**: 保存時のバリデーションエラー処理を確認
- **前提条件**: apiV2がバリデーションエラーを返す
- **実行手順**:
  1. ダイアログから無効な教科データを送信
  2. バリデーションエラー用のトーストが表示されることを確認
- **期待結果**: バリデーションエラーメッセージ表示
- **分岐カバレッジ**: 保存バリデーションエラー分岐

#### 1.2.4 一括保存機能テスト

**TC-FE-SS-019: 全教科情報保存（成功）**
- **目的**: 全教科の一括保存成功ケースを確認
- **前提条件**: 有効なtoken、教科データ
- **実行手順**:
  1. 「教科情報を保存」ボタンをクリック
  2. 各教科のupdateSubjectが呼び出されることを確認
  3. 成功トーストが表示されることを確認
- **期待結果**: 全教科が保存される
- **分岐カバレッジ**: 一括保存成功分岐

**TC-FE-SS-020: 全教科情報保存（部分失敗）**
- **目的**: 一部教科の保存が失敗した場合を確認
- **前提条件**: 一部のupdateSubject呼び出しが失敗
- **実行手順**:
  1. 「教科情報を保存」ボタンをクリック
  2. 部分失敗トーストが表示されることを確認
- **期待結果**: 部分失敗メッセージ表示
- **分岐カバレッジ**: failCount > 0分岐

### 1.3 ClassroomsSection コンポーネント

#### 1.3.1 レンダリング系テスト

**TC-FE-CS-001: 教室一覧正常表示**
- **目的**: 教室データの正常表示を確認
- **前提条件**: 有効な教室データ
- **実行手順**:
  1. 教室名が表示されることを確認
  2. 教室タイプがBadgeで表示されることを確認
  3. 教室数が表示されることを確認
- **期待結果**: 全教室情報が正しく表示
- **分岐カバレッジ**: 正常表示分岐

**TC-FE-CS-002: 教室データ読み込み（成功）**
- **目的**: 教室データの正常読み込みを確認
- **前提条件**: 有効なtoken、API正常応答
- **実行手順**:
  1. コンポーネントをマウント
  2. apiV2.classrooms.getClassroomsが呼び出されることを確認
  3. 取得した教室データが状態に設定されることを確認
  4. 順序によるソートが適用されることを確認
- **期待結果**: 教室データが正常に読み込まれソートされる
- **分岐カバレッジ**: 読み込み・ソート成功分岐

**TC-FE-CS-003: 教室削除（成功）**
- **目的**: 教室削除処理の成功ケースを確認
- **前提条件**: 有効なtoken、既存教室ID
- **実行手順**:
  1. 教室の削除ボタンをクリック
  2. apiV2.classrooms.deleteClassroomが呼び出されることを確認
  3. classrooms状態から該当教室が除外されることを確認
  4. 成功トーストが表示されることを確認
- **期待結果**: 教室が削除される
- **分岐カバレッジ**: 教室削除成功分岐

**TC-FE-CS-004: 教室削除（バリデーションエラー）**
- **目的**: 教室削除時のバリデーションエラー処理確認
- **前提条件**: apiV2がバリデーションエラーを返す
- **実行手順**:
  1. 教室の削除ボタンをクリック
  2. バリデーションエラー用のトーストが表示されることを確認
- **期待結果**: バリデーションエラーメッセージ表示
- **分岐カバレッジ**: 教室削除バリデーションエラー分岐

## 2. カスタムフック単体テスト仕様

### 2.1 use-teacher-api フック

#### テスト環境セットアップ
```typescript
describe('useTeacherApi', () => {
  const mockToken = 'test-token'
  const mockGetFreshToken = jest.fn()
  
  beforeEach(() => {
    jest.clearAllMocks()
    // 統合APIのモック設定
  })
})
```

#### 2.1.1 初期化とデータ読み込みテスト

**TC-HK-TA-001: フック初期化**
- **目的**: フックの初期状態を確認
- **前提条件**: 有効なtoken
- **実行手順**:
  1. useTeacherApiフックを呼び出し
  2. 初期状態を確認：isLoading=true, isSaving=false
  3. subjects=[], schoolSettings=デフォルト値
- **期待結果**: 正しい初期状態
- **分岐カバレッジ**: 初期化分岐

**TC-HK-TA-002: 初期データ読み込み（成功）**
- **目的**: 教科と学校設定の初期読み込み成功ケース
- **前提条件**: API正常応答
- **実行手順**:
  1. フックをマウント
  2. apiV2.subjects.getSubjectsとapiV2.schoolSettings.getSettingsが並行呼び出しされることを確認
  3. 取得データが状態に設定されることを確認
  4. isLoadingがfalseになることを確認
- **期待結果**: 初期データが正常に読み込まれる
- **分岐カバレッジ**: 読み込み成功分岐

**TC-HK-TA-003: 初期データ読み込み（エラー）**
- **目的**: 初期データ読み込み時のエラー処理確認
- **前提条件**: API呼び出しでエラー
- **実行手順**:
  1. フックをマウント
  2. エラーがコンソールに出力されることを確認
  3. isLoadingがfalseになることを確認
- **期待結果**: エラー処理が適切に実行される
- **分岐カバレッジ**: 読み込みエラー分岐

**TC-HK-TA-004: tokenなしでの初期化**
- **目的**: tokenがない場合の処理確認
- **前提条件**: token = null
- **実行手順**:
  1. フックをマウント
  2. API呼び出しがスキップされることを確認
  3. isLoadingがfalseになることを確認
- **期待結果**: API呼び出しなしで完了
- **分岐カバレッジ**: tokenなし分岐

#### 2.1.2 教師保存機能テスト

**TC-HK-TA-005: 新規教師作成（成功）**
- **目的**: 新規教師作成の成功ケース確認
- **前提条件**: isNewTeacher=true、有効な教師データ
- **実行手順**:
  1. saveTeacher関数を呼び出し
  2. apiV2.teachers.createTeacherが呼び出されることを確認
  3. 成功トーストが表示されることを確認
  4. 作成された教師データが返されることを確認
- **期待結果**: 新規教師が作成される
- **分岐カバレッジ**: 新規作成成功分岐

**TC-HK-TA-006: 教師更新（成功）**
- **目的**: 既存教師更新の成功ケース確認
- **前提条件**: isNewTeacher=false、教師ID存在
- **実行手順**:
  1. saveTeacher関数を呼び出し
  2. apiV2.teachers.updateTeacherが呼び出されることを確認
  3. 成功トーストが表示されることを確認
  4. 更新された教師データが返されることを確認
- **期待結果**: 教師が更新される
- **分岐カバレッジ**: 更新成功分岐

**TC-HK-TA-007: 教師保存（IDなしエラー）**
- **目的**: 更新時にIDがない場合のエラー処理確認
- **前提条件**: isNewTeacher=false、teacherData.id=undefined
- **実行手順**:
  1. saveTeacher関数を呼び出し
  2. "教師IDが見つかりません"エラーがスローされることを確認
- **期待結果**: IDなしエラーが発生
- **分岐カバレッジ**: IDなしエラー分岐

**TC-HK-TA-008: 教師保存（バリデーションエラー）**
- **目的**: 保存時のバリデーションエラー処理確認
- **前提条件**: apiV2がバリデーションエラーを返す
- **実行手順**:
  1. saveTeacher関数を呼び出し
  2. バリデーションエラー用のトーストが表示されることを確認
  3. エラーが再スローされることを確認
- **期待結果**: バリデーションエラー処理
- **分岐カバレッジ**: バリデーションエラー分岐

**TC-HK-TA-009: 教師保存（一般エラー）**
- **目的**: 保存時の一般エラー処理確認
- **前提条件**: apiV2が一般エラーを返す
- **実行手順**:
  1. saveTeacher関数を呼び出し
  2. 一般エラー用のトーストが表示されることを確認
  3. エラーが再スローされることを確認
- **期待結果**: 一般エラー処理
- **分岐カバレッジ**: 一般エラー分岐

#### 2.1.3 状態管理テスト

**TC-HK-TA-010: ローディング状態管理**
- **目的**: isSaving状態の適切な管理確認
- **前提条件**: 教師保存処理
- **実行手順**:
  1. saveTeacher関数を呼び出し
  2. 処理開始時にisSaving=trueになることを確認
  3. 処理完了時にisSaving=falseになることを確認
- **期待結果**: ローディング状態が適切に管理される
- **分岐カバレッジ**: ローディング状態分岐

**TC-HK-TA-011: availableGradesの提供**
- **目的**: 利用可能学年リストの提供確認
- **前提条件**: フック呼び出し
- **実行手順**:
  1. 返り値のavailableGradesを確認
  2. ['1', '2', '3']が設定されていることを確認
- **期待結果**: 学年リストが正しく提供される
- **分岐カバレッジ**: availableGrades提供分岐

### 2.2 use-subject-api フック

#### 2.2.1 初期化とデータ読み込みテスト

**TC-HK-SA-001: フック初期化**
- **目的**: use-subject-apiフックの初期状態確認
- **前提条件**: 有効なtoken
- **実行手順**:
  1. useSubjectApiフックを呼び出し
  2. 初期状態を確認：isLoading=true, isSaving=false
  3. classrooms=[]
- **期待結果**: 正しい初期状態
- **分岐カバレッジ**: 初期化分岐

**TC-HK-SA-002: 教室データ読み込み（成功）**
- **目的**: 教室データの正常読み込み確認
- **前提条件**: API正常応答
- **実行手順**:
  1. フックをマウント
  2. apiV2.classrooms.getClassroomsが呼び出されることを確認
  3. 取得した教室データが状態に設定されることを確認
  4. isLoadingがfalseになることを確認
- **期待結果**: 教室データが正常に読み込まれる
- **分岐カバレッジ**: 読み込み成功分岐

**TC-HK-SA-003: 教室データ読み込み（エラー）**
- **目的**: 教室データ読み込み時のエラー処理確認
- **前提条件**: API呼び出しでエラー
- **実行手順**:
  1. フックをマウント
  2. エラーがコンソールに出力されることを確認
  3. 空配列が設定されることを確認
  4. isLoadingがfalseになることを確認
- **期待結果**: エラー処理で空配列設定
- **分岐カバレッジ**: 読み込みエラー分岐

#### 2.2.2 教科保存機能テスト

**TC-HK-SA-004: 新規教科作成（成功）**
- **目的**: 新規教科作成の成功ケース確認
- **前提条件**: isNewSubject=true、有効な教科データ
- **実行手順**:
  1. saveSubject関数を呼び出し
  2. apiV2.subjects.createSubjectが呼び出されることを確認
  3. 成功トーストが表示されることを確認
  4. 作成された教科データが返されることを確認
- **期待結果**: 新規教科が作成される
- **分岐カバレッジ**: 新規作成成功分岐

**TC-HK-SA-005: 教科更新（成功）**
- **目的**: 既存教科更新の成功ケース確認
- **前提条件**: isNewSubject=false、教科ID存在
- **実行手順**:
  1. saveSubject関数を呼び出し
  2. apiV2.subjects.updateSubjectが呼び出されることを確認
  3. 成功トーストが表示されることを確認
  4. 更新された教科データが返されることを確認
- **期待結果**: 教科が更新される
- **分岐カバレッジ**: 更新成功分岐

**TC-HK-SA-006: 教科保存（IDなしエラー）**
- **目的**: 更新時にIDがない場合のエラー処理確認
- **前提条件**: isNewSubject=false、subjectData.id=undefined
- **実行手順**:
  1. saveSubject関数を呼び出し
  2. "教科IDが見つかりません"エラーがスローされることを確認
- **期待結果**: IDなしエラーが発生
- **分岐カバレッジ**: IDなしエラー分岐

## 3. バックエンドAPI単体テスト仕様

### 3.1 型安全API v2エンドポイント

#### テスト環境セットアップ
```typescript
describe('API v2 Endpoints', () => {
  let app: Hono
  let env: CloudflareEnv
  
  beforeEach(async () => {
    // テスト環境初期化
    app = createApp()
    env = createTestEnv()
  })
})
```

#### 3.1.1 教師管理API

**TC-BE-TA-001: GET /api/teachers（成功）**
- **目的**: 教師一覧取得の正常ケース確認
- **前提条件**: 有効な認証、教師データ存在
- **実行手順**:
  1. GET /api/teachersリクエスト送信
  2. 200ステータスコードが返されることを確認
  3. 教師データ配列が返されることを確認
  4. Zodスキーマ検証が通ることを確認
- **期待結果**: 教師一覧が正常に返される
- **分岐カバレッジ**: 正常応答分岐

**TC-BE-TA-002: GET /api/teachers（ページネーション）**
- **目的**: ページネーション付き教師一覧取得確認
- **前提条件**: クエリパラメータpage=2&limit=5
- **実行手順**:
  1. ページネーション付きリクエスト送信
  2. 指定された件数のデータが返されることを確認
  3. ページネーション情報が含まれることを確認
- **期待結果**: ページネーション処理が正常に動作
- **分岐カバレッジ**: ページネーション分岐

**TC-BE-TA-003: GET /api/teachers（検索）**
- **目的**: 教師名検索機能の確認
- **前提条件**: search=田中クエリパラメータ
- **実行手順**:
  1. 検索付きリクエスト送信
  2. 検索条件に一致する教師のみ返されることを確認
- **期待結果**: 検索機能が正常に動作
- **分岐カバレッジ**: 検索処理分岐

**TC-BE-TA-004: POST /api/teachers（成功）**
- **目的**: 新規教師作成の正常ケース確認
- **前提条件**: 有効な教師データ
- **実行手順**:
  1. POST /api/teachersリクエスト送信
  2. 201ステータスコードが返されることを確認
  3. 作成された教師データが返されることを確認
  4. データベースに保存されることを確認
- **期待結果**: 教師が正常に作成される
- **分岐カバレッジ**: 作成成功分岐

**TC-BE-TA-005: POST /api/teachers（バリデーションエラー）**
- **目的**: 教師作成時のバリデーションエラー処理確認
- **前提条件**: 無効な教師データ（name欠如等）
- **実行手順**:
  1. 無効なデータでPOSTリクエスト送信
  2. 400ステータスコードが返されることを確認
  3. バリデーションエラー詳細が返されることを確認
- **期待結果**: バリデーションエラーが適切に処理される
- **分岐カバレッジ**: バリデーションエラー分岐

**TC-BE-TA-006: GET /api/teachers/{id}（成功）**
- **目的**: 特定教師取得の正常ケース確認
- **前提条件**: 存在する教師ID
- **実行手順**:
  1. GET /api/teachers/{id}リクエスト送信
  2. 200ステータスコードが返されることを確認
  3. 指定IDの教師データが返されることを確認
- **期待結果**: 特定教師が正常に返される
- **分岐カバレッジ**: 詳細取得成功分岐

**TC-BE-TA-007: GET /api/teachers/{id}（404エラー）**
- **目的**: 存在しない教師ID指定時の処理確認
- **前提条件**: 存在しない教師ID
- **実行手順**:
  1. 存在しないIDでGETリクエスト送信
  2. 404ステータスコードが返されることを確認
  3. 適切なエラーメッセージが返されることを確認
- **期待結果**: 404エラーが適切に処理される
- **分岐カバレッジ**: 教師見つからず分岐

**TC-BE-TA-008: PUT /api/teachers/{id}（成功）**
- **目的**: 教師更新の正常ケース確認
- **前提条件**: 存在する教師ID、有効な更新データ
- **実行手順**:
  1. PUT /api/teachers/{id}リクエスト送信
  2. 200ステータスコードが返されることを確認
  3. 更新された教師データが返されることを確認
  4. データベースで更新されることを確認
- **期待結果**: 教師が正常に更新される
- **分岐カバレッジ**: 更新成功分岐

**TC-BE-TA-009: PUT /api/teachers/{id}（部分更新）**
- **目的**: 教師の部分更新機能確認
- **前提条件**: 一部フィールドのみの更新データ
- **実行手順**:
  1. 部分更新データでPUTリクエスト送信
  2. 指定フィールドのみ更新されることを確認
  3. 他フィールドは変更されないことを確認
- **期待結果**: 部分更新が正常に動作
- **分岐カバレッジ**: 部分更新分岐

**TC-BE-TA-010: DELETE /api/teachers/{id}（成功）**
- **目的**: 教師削除の正常ケース確認
- **前提条件**: 存在する教師ID
- **実行手順**:
  1. DELETE /api/teachers/{id}リクエスト送信
  2. 204ステータスコードが返されることを確認
  3. データベースから削除されることを確認
- **期待結果**: 教師が正常に削除される
- **分岐カバレッジ**: 削除成功分岐

#### 3.1.2 教科管理API

**TC-BE-SA-001: GET /api/subjects（成功）**
- **目的**: 教科一覧取得の正常ケース確認
- **前提条件**: 有効な認証、教科データ存在
- **実行手順**:
  1. GET /api/subjectsリクエスト送信
  2. 200ステータスコードが返されることを確認
  3. 教科データ配列が返されることを確認
  4. targetGrades配列が正規化されていることを確認
- **期待結果**: 教科一覧が正常に返される
- **分岐カバレッジ**: 正常応答分岐

**TC-BE-SA-002: POST /api/subjects（成功）**
- **目的**: 新規教科作成の正常ケース確認
- **前提条件**: 有効な教科データ
- **実行手順**:
  1. POST /api/subjectsリクエスト送信
  2. 201ステータスコードが返されることを確認
  3. 作成された教科データが返されることを確認
  4. targetGradesが正しく保存されることを確認
- **期待結果**: 教科が正常に作成される
- **分岐カバレッジ**: 作成成功分岐

**TC-BE-SA-003: PUT /api/subjects/{id}（成功）**
- **目的**: 教科更新の正常ケース確認
- **前提条件**: 存在する教科ID、有効な更新データ
- **実行手順**:
  1. PUT /api/subjects/{id}リクエスト送信
  2. 200ステータスコードが返されることを確認
  3. 更新された教科データが返されることを確認
  4. targetGradesが正しく更新されることを確認
- **期待結果**: 教科が正常に更新される
- **分岐カバレッジ**: 更新成功分岐

**TC-BE-SA-004: DELETE /api/subjects/{id}（成功）**
- **目的**: 教科削除の正常ケース確認
- **前提条件**: 存在する教科ID
- **実行手順**:
  1. DELETE /api/subjects/{id}リクエスト送信
  2. 204ステータスコードが返されることを確認
  3. データベースから削除されることを確認
- **期待結果**: 教科が正常に削除される
- **分岐カバレッジ**: 削除成功分岐

#### 3.1.3 教室管理API

**TC-BE-CA-001: GET /api/classrooms（成功）**
- **目的**: 教室一覧取得の正常ケース確認
- **前提条件**: 有効な認証、教室データ存在
- **実行手順**:
  1. GET /api/classroomsリクエスト送信
  2. 200ステータスコードが返されることを確認
  3. 教室データ配列が返されることを確認
  4. order順でソートされていることを確認
- **期待結果**: 教室一覧が正常に返される
- **分岐カバレッジ**: 正常応答分岐

**TC-BE-CA-002: POST /api/classrooms（成功）**
- **目的**: 新規教室作成の正常ケース確認
- **前提条件**: 有効な教室データ
- **実行手順**:
  1. POST /api/classroomsリクエスト送信
  2. 201ステータスコードが返されることを確認
  3. 作成された教室データが返されることを確認
- **期待結果**: 教室が正常に作成される
- **分岐カバレッジ**: 作成成功分岐

**TC-BE-CA-003: DELETE /api/classrooms/{id}（成功）**
- **目的**: 教室削除の正常ケース確認
- **前提条件**: 存在する教室ID
- **実行手順**:
  1. DELETE /api/classrooms/{id}リクエスト送信
  2. 204ステータスコードが返されることを確認
  3. データベースから削除されることを確認
- **期待結果**: 教室が正常に削除される
- **分岐カバレッジ**: 削除成功分岐

#### 3.1.4 学校設定API

**TC-BE-SS-001: GET /api/school/settings（成功）**
- **目的**: 学校設定取得の正常ケース確認
- **前提条件**: 学校設定データ存在
- **実行手順**:
  1. GET /api/school/settingsリクエスト送信
  2. 200ステータスコードが返されることを確認
  3. 拡張学校設定データが返されることを確認
  4. EnhancedSchoolSettingsスキーマに適合することを確認
- **期待結果**: 学校設定が正常に返される
- **分岐カバレッジ**: 正常応答分岐

**TC-BE-SS-002: PUT /api/school/settings（成功）**
- **目的**: 学校設定更新の正常ケース確認
- **前提条件**: 有効な学校設定データ
- **実行手順**:
  1. PUT /api/school/settingsリクエスト送信
  2. 200ステータスコードが返されることを確認
  3. 更新された学校設定が返されることを確認
  4. データベースで更新されることを確認
- **期待結果**: 学校設定が正常に更新される
- **分岐カバレッジ**: 更新成功分岐

#### 3.1.5 APIドキュメント関連

**TC-BE-DOC-001: GET /api/docs（Swagger UI）**
- **目的**: Swagger UIの表示確認
- **前提条件**: なし
- **実行手順**:
  1. GET /api/docsリクエスト送信
  2. 200ステータスコードが返されることを確認
  3. HTML形式のSwagger UIが返されることを確認
- **期待結果**: Swagger UIが正常に表示される
- **分岐カバレッジ**: Swagger UI表示分岐

**TC-BE-DOC-002: GET /api/spec（OpenAPI仕様）**
- **目的**: OpenAPI仕様の取得確認
- **前提条件**: なし
- **実行手順**:
  1. GET /api/specリクエスト送信
  2. 200ステータスコードが返されることを確認
  3. JSON形式のOpenAPI仕様が返されることを確認
- **期待結果**: OpenAPI仕様が正常に返される
- **分岐カバレッジ**: OpenAPI仕様生成分岐

## 4. サービス層単体テスト仕様

### 4.1 TypeSafeSchoolService

#### テスト環境セットアップ
```typescript
describe('TypeSafeSchoolService', () => {
  let service: TypeSafeSchoolService
  let mockDbHelper: jest.Mocked<TypeSafeDbHelper>
  
  beforeEach(() => {
    mockDbHelper = createMockDbHelper()
    service = new TypeSafeSchoolService(mockDbHelper)
  })
})
```

#### 4.1.1 教師管理機能

**TC-SV-SS-001: getAllTeachers（成功）**
- **目的**: 全教師取得の正常ケース確認
- **前提条件**: データベースに教師データ存在
- **実行手順**:
  1. getAllTeachers()を呼び出し
  2. データベースクエリが実行されることを確認
  3. 教師データ配列が返されることを確認
  4. subjectsとgradesが正規化されることを確認
- **期待結果**: 全教師データが正常に返される
- **分岐カバレッジ**: 取得成功分岐

**TC-SV-SS-002: getTeacherById（成功）**
- **目的**: 特定教師取得の正常ケース確認
- **前提条件**: 存在する教師ID
- **実行手順**:
  1. getTeacherById(id)を呼び出し
  2. 指定IDの教師が返されることを確認
  3. データが正規化されていることを確認
- **期待結果**: 指定教師が正常に返される
- **分岐カバレッジ**: 取得成功分岐

**TC-SV-SS-003: getTeacherById（404エラー）**
- **目的**: 存在しない教師ID指定時の処理確認
- **前提条件**: 存在しない教師ID
- **実行手順**:
  1. getTeacherById(invalidId)を呼び出し
  2. NotFoundErrorがスローされることを確認
- **期待結果**: 404エラーが適切にスローされる
- **分岐カバレッジ**: 教師見つからず分岐

**TC-SV-SS-004: createTeacher（成功）**
- **目的**: 新規教師作成の正常ケース確認
- **前提条件**: 有効な教師データ
- **実行手順**:
  1. createTeacher(teacherData)を呼び出し
  2. データベースにINSERTが実行されることを確認
  3. 作成された教師データが返されることを確認
  4. subjectsとgradesがJSON文字列で保存されることを確認
- **期待結果**: 教師が正常に作成される
- **分岐カバレッジ**: 作成成功分岐

**TC-SV-SS-005: updateTeacher（成功）**
- **目的**: 教師更新の正常ケース確認
- **前提条件**: 存在する教師ID、有効な更新データ
- **実行手順**:
  1. updateTeacher(id, updateData)を呼び出し
  2. データベースでUPDATEが実行されることを確認
  3. 更新された教師データが返されることを確認
- **期待結果**: 教師が正常に更新される
- **分岐カバレッジ**: 更新成功分岐

**TC-SV-SS-006: deleteTeacher（成功）**
- **目的**: 教師削除の正常ケース確認
- **前提条件**: 存在する教師ID
- **実行手順**:
  1. deleteTeacher(id)を呼び出し
  2. データベースでDELETEが実行されることを確認
  3. 成功応答が返されることを確認
- **期待結果**: 教師が正常に削除される
- **分岐カバレッジ**: 削除成功分岐

#### 4.1.2 教科管理機能

**TC-SV-SS-007: getAllSubjects（成功）**
- **目的**: 全教科取得の正常ケース確認
- **前提条件**: データベースに教科データ存在
- **実行手順**:
  1. getAllSubjects()を呼び出し
  2. データベースクエリが実行されることを確認
  3. 教科データ配列が返されることを確認
  4. targetGradesが正規化されることを確認
- **期待結果**: 全教科データが正常に返される
- **分岐カバレッジ**: 取得成功分岐

**TC-SV-SS-008: createSubject（成功）**
- **目的**: 新規教科作成の正常ケース確認
- **前提条件**: 有効な教科データ
- **実行手順**:
  1. createSubject(subjectData)を呼び出し
  2. データベースにINSERTが実行されることを確認
  3. 作成された教科データが返されることを確認
  4. targetGradesがJSON文字列で保存されることを確認
- **期待結果**: 教科が正常に作成される
- **分岐カバレッジ**: 作成成功分岐

#### 4.1.3 教室管理機能

**TC-SV-SS-009: getAllClassrooms（成功）**
- **目的**: 全教室取得の正常ケース確認
- **前提条件**: データベースに教室データ存在
- **実行手順**:
  1. getAllClassrooms()を呼び出し
  2. データベースクエリが実行されることを確認
  3. 教室データ配列が返されることを確認
  4. order順でソートされていることを確認
- **期待結果**: 全教室データが正常に返される
- **分岐カバレッジ**: 取得成功分岐

#### 4.1.4 学校設定管理機能

**TC-SV-SS-010: getSchoolSettings（成功）**
- **目的**: 学校設定取得の正常ケース確認
- **前提条件**: データベースに学校設定存在
- **実行手順**:
  1. getSchoolSettings()を呼び出し
  2. データベースクエリが実行されることを確認
  3. EnhancedSchoolSettings形式で返されることを確認
  4. 拡張プロパティが含まれることを確認
- **期待結果**: 学校設定が正常に返される
- **分岐カバレッジ**: 取得成功分岐

**TC-SV-SS-011: getSchoolSettings（デフォルト値）**
- **目的**: 学校設定が存在しない場合のデフォルト値確認
- **前提条件**: データベースに学校設定なし
- **実行手順**:
  1. getSchoolSettings()を呼び出し
  2. デフォルト値が返されることを確認
- **期待結果**: デフォルト学校設定が返される
- **分岐カバレッジ**: デフォルト値分岐

### 4.2 TypeSafeTimetableGenerationEngine

#### 4.2.1 時間割生成機能

**TC-SV-TG-001: generateTimetable（基本生成）**
- **目的**: 基本的な時間割生成の正常ケース確認
- **前提条件**: 有効な制約条件、標準生成オプション
- **実行手順**:
  1. generateTimetable(constraints, options)を呼び出し
  2. 制約条件のZod検証が通ることを確認
  3. 時間割データが生成されることを確認
  4. 統計情報が含まれることを確認
- **期待結果**: 基本時間割が正常に生成される
- **分岐カバレッジ**: 基本生成成功分岐

**TC-SV-TG-002: generateTimetable（最適化生成）**
- **目的**: 最適化された時間割生成の確認
- **前提条件**: method='optimized'のオプション
- **実行手順**:
  1. 最適化オプションでgenerateTimetableを呼び出し
  2. 最適化アルゴリズムが実行されることを確認
  3. 品質指標が向上していることを確認
- **期待結果**: 最適化時間割が生成される
- **分岐カバレッジ**: 最適化生成分岐

**TC-SV-TG-003: generateTimetable（AI強化生成）**
- **目的**: AI強化時間割生成の確認
- **前提条件**: method='ai-enhanced'のオプション
- **実行手順**:
  1. AI強化オプションでgenerateTimetableを呼び出し
  2. AI処理が実行されることを確認
  3. 高度な制約解決が行われることを確認
- **期待結果**: AI強化時間割が生成される
- **分岐カバレッジ**: AI強化生成分岐

**TC-SV-TG-004: validateConstraints（成功）**
- **目的**: 制約条件検証の正常ケース確認
- **前提条件**: 有効な制約条件
- **実行手順**:
  1. validateConstraints(constraints)を呼び出し
  2. 検証が成功することを確認
  3. 検証結果が返されることを確認
- **期待結果**: 制約条件が正常に検証される
- **分岐カバレッジ**: 検証成功分岐

**TC-SV-TG-005: validateConstraints（エラー）**
- **目的**: 無効な制約条件での検証エラー確認
- **前提条件**: 無効な制約条件（矛盾等）
- **実行手順**:
  1. validateConstraints(invalidConstraints)を呼び出し
  2. 検証エラーが検出されることを確認
  3. エラー詳細が返されることを確認
- **期待結果**: 制約違反が適切に検出される
- **分岐カバレッジ**: 検証エラー分岐

### 4.3 TypeSafeDbHelper

#### 4.3.1 データベース操作

**TC-SV-DB-001: executeQuery（SELECT成功）**
- **目的**: SELECT クエリの正常実行確認
- **前提条件**: 有効なSELECTクエリ
- **実行手順**:
  1. executeQuery(selectSql, params)を呼び出し
  2. データベースクエリが実行されることを確認
  3. 結果セットが返されることを確認
- **期待結果**: SELECTクエリが正常に実行される
- **分岐カバレッジ**: SELECT成功分岐

**TC-SV-DB-002: executeQuery（INSERT成功）**
- **目的**: INSERT クエリの正常実行確認
- **前提条件**: 有効なINSERTクエリ
- **実行手順**:
  1. executeQuery(insertSql, params)を呼び出し
  2. データベースにデータが挿入されることを確認
  3. 挿入行数が返されることを確認
- **期待結果**: INSERTクエリが正常に実行される
- **分岐カバレッジ**: INSERT成功分岐

**TC-SV-DB-003: executeQuery（エラー）**
- **目的**: クエリ実行時のエラー処理確認
- **前提条件**: 無効なSQLクエリ
- **実行手順**:
  1. executeQuery(invalidSql)を呼び出し
  2. DatabaseErrorがスローされることを確認
  3. エラー詳細が含まれることを確認
- **期待結果**: データベースエラーが適切に処理される
- **分岐カバレッジ**: クエリエラー分岐

#### 4.3.2 トランザクション管理

**TC-SV-DB-004: withTransaction（成功）**
- **目的**: トランザクション処理の正常ケース確認
- **前提条件**: 有効なトランザクション処理
- **実行手順**:
  1. withTransaction(callback)を呼び出し
  2. トランザクションが開始されることを確認
  3. 処理が正常完了することを確認
  4. コミットが実行されることを確認
- **期待結果**: トランザクションが正常に完了する
- **分岐カバレッジ**: トランザクション成功分岐

**TC-SV-DB-005: withTransaction（ロールバック）**
- **目的**: トランザクション処理でのロールバック確認
- **前提条件**: エラーが発生するトランザクション処理
- **実行手順**:
  1. エラーを発生させるcallbackでwithTransactionを呼び出し
  2. エラーがキャッチされることを確認
  3. ロールバックが実行されることを確認
- **期待結果**: エラー時に適切にロールバックされる
- **分岐カバレッジ**: ロールバック分岐

## 5. Zodスキーマ検証テスト仕様

### 5.1 基本型スキーマ

#### 5.1.1 教師スキーマ

**TC-ZD-TE-001: TeacherSchema（正常データ）**
- **目的**: 正常な教師データの検証確認
- **前提条件**: 完全で有効な教師データ
- **実行手順**:
  1. TeacherSchema.parse(validTeacherData)を呼び出し
  2. 検証が成功することを確認
  3. 正規化されたデータが返されることを確認
- **期待結果**: 教師データが正常に検証される
- **分岐カバレッジ**: 正常検証分岐

**TC-ZD-TE-002: TeacherSchema（必須フィールド欠如）**
- **目的**: 必須フィールド欠如時の検証エラー確認
- **前提条件**: name フィールドなしの教師データ
- **実行手順**:
  1. TeacherSchema.parse(incompleteData)を呼び出し
  2. ZodErrorがスローされることを確認
  3. エラー詳細にname欠如が含まれることを確認
- **期待結果**: 必須フィールドエラーが検出される
- **分岐カバレッジ**: 必須フィールドエラー分岐

**TC-ZD-TE-003: TeacherSchema（無効な型）**
- **目的**: 無効なデータ型での検証エラー確認
- **前提条件**: name が数値の教師データ
- **実行手順**:
  1. TeacherSchema.parse(invalidTypeData)を呼び出し
  2. ZodErrorがスローされることを確認
  3. 型エラーが含まれることを確認
- **期待結果**: 型エラーが適切に検出される
- **分岐カバレッジ**: 型エラー分岐

#### 5.1.2 教科スキーマ

**TC-ZD-SU-001: SubjectSchema（正常データ）**
- **目的**: 正常な教科データの検証確認
- **前提条件**: 完全で有効な教科データ
- **実行手順**:
  1. SubjectSchema.parse(validSubjectData)を呼び出し
  2. 検証が成功することを確認
  3. targetGrades配列が正規化されることを確認
- **期待結果**: 教科データが正常に検証される
- **分岐カバレッジ**: 正常検証分岐

**TC-ZD-SU-002: SubjectSchema（無効なweekly_hours）**
- **目的**: 無効な週授業数での検証エラー確認
- **前提条件**: weekly_hours が負数の教科データ
- **実行手順**:
  1. SubjectSchema.parse(invalidWeeklyHours)を呼び出し
  2. ZodErrorがスローされることを確認
  3. 週授業数エラーが含まれることを確認
- **期待結果**: 週授業数エラーが検出される
- **分岐カバレッジ**: 週授業数エラー分岐

#### 5.1.3 学校設定スキーマ

**TC-ZD-SS-001: SchoolSettingsSchema（正常データ）**
- **目的**: 正常な学校設定データの検証確認
- **前提条件**: 有効な学校設定データ
- **実行手順**:
  1. SchoolSettingsSchema.parse(validSettings)を呼び出し
  2. 検証が成功することを確認
  3. 全クラス数と期間数が適切に検証されることを確認
- **期待結果**: 学校設定が正常に検証される
- **分岐カバレッジ**: 正常検証分岐

**TC-ZD-SS-002: EnhancedSchoolSettingsSchema（拡張プロパティ）**
- **目的**: 拡張学校設定スキーマの検証確認
- **前提条件**: 拡張プロパティ付き学校設定
- **実行手順**:
  1. EnhancedSchoolSettingsSchema.parse(enhancedSettings)を呼び出し
  2. 検証が成功することを確認
  3. 計算されたプロパティが含まれることを確認
- **期待結果**: 拡張学校設定が正常に検証される
- **分岐カバレッジ**: 拡張検証分岐

### 5.2 時間割生成スキーマ

#### 5.2.1 制約条件スキーマ

**TC-ZD-TC-001: TimetableConstraintsSchema（正常データ）**
- **目的**: 正常な制約条件データの検証確認
- **前提条件**: 有効な制約条件
- **実行手順**:
  1. TimetableConstraintsSchema.parse(validConstraints)を呼び出し
  2. 検証が成功することを確認
  3. 全制約条件が適切に検証されることを確認
- **期待結果**: 制約条件が正常に検証される
- **分岐カバレッジ**: 正常制約検証分岐

**TC-ZD-TC-002: TimetableConstraintsSchema（無効な時間範囲）**
- **目的**: 無効な時間範囲での検証エラー確認
- **前提条件**: 開始時間 > 終了時間の制約
- **実行手順**:
  1. TimetableConstraintsSchema.parse(invalidTimeRange)を呼び出し
  2. ZodErrorがスローされることを確認
  3. 時間範囲エラーが含まれることを確認
- **期待結果**: 時間範囲エラーが検出される
- **分岐カバレッジ**: 時間範囲エラー分岐

#### 5.2.2 生成結果スキーマ

**TC-ZD-TR-001: TimetableGenerationResultSchema（成功結果）**
- **目的**: 正常な生成結果の検証確認
- **前提条件**: 成功した時間割生成結果
- **実行手順**:
  1. TimetableGenerationResultSchema.parse(successResult)を呼び出し
  2. 検証が成功することを確認
  3. 統計情報が含まれることを確認
- **期待結果**: 生成結果が正常に検証される
- **分岐カバレッジ**: 成功結果検証分岐

**TC-ZD-TR-002: TimetableGenerationResultSchema（失敗結果）**
- **目的**: 失敗した生成結果の検証確認
- **前提条件**: 失敗した時間割生成結果
- **実行手順**:
  1. TimetableGenerationResultSchema.parse(failureResult)を呼び出し
  2. success=falseの結果が検証されることを確認
  3. エラーメッセージが含まれることを確認
- **期待結果**: 失敗結果が正常に検証される
- **分岐カバレッジ**: 失敗結果検証分岐

## 6. 統合テスト仕様

### 6.1 フロントエンド・バックエンド統合

**TC-IT-001: 教師CRUD完全フロー**
- **目的**: 教師の作成から削除までの完全フロー確認
- **前提条件**: 認証済みユーザー、クリーンなデータベース
- **実行手順**:
  1. TeachersSectionで新規教師を作成
  2. apiV2経由でバックエンドに保存
  3. データベースに正しく保存されることを確認
  4. UI上で教師が表示されることを確認
  5. 教師を編集し更新処理を実行
  6. 教師を削除し、UI・DBから除去されることを確認
- **期待結果**: 完全なCRUDフローが正常に動作
- **分岐カバレッジ**: 全CRUD操作分岐

**TC-IT-002: 型安全性エンドツーエンド**
- **目的**: フロントエンドからバックエンドまでの型安全性確認
- **前提条件**: 型安全API v2使用
- **実行手順**:
  1. フロントエンドで無効なデータを送信
  2. Zodスキーマ検証でエラーが検出されることを確認
  3. 適切なエラーレスポンスが返されることを確認
  4. フロントエンドでエラーが適切に処理されることを確認
- **期待結果**: 型安全性が全層で保証される
- **分岐カバレッジ**: 全層型安全検証分岐

## 7. テスト実装指針

### 7.1 テスト環境構築

```typescript
// Jest設定例
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/test/setup.ts'],
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{ts,tsx}',
  ],
  coverageThreshold: {
    global: {
      branches: 100,
      functions: 100,
      lines: 100,
      statements: 100,
    },
  },
}
```

### 7.2 モック戦略

```typescript
// apiV2モック例
jest.mock('../lib/api/v2', () => ({
  teachers: {
    getTeachers: jest.fn(),
    createTeacher: jest.fn(),
    updateTeacher: jest.fn(),
    deleteTeacher: jest.fn(),
  },
  isValidationError: jest.fn(),
}))
```

### 7.3 カバレッジ要件

- **分岐カバレッジ**: 100%必須
- **関数カバレッジ**: 100%必須  
- **行カバレッジ**: 100%必須
- **ステートメントカバレッジ**: 100%必須

### 7.4 実行順序

1. Zodスキーマテスト（基盤）
2. サービス層単体テスト
3. バックエンドAPI単体テスト
4. カスタムフック単体テスト
5. フロントエンドコンポーネント単体テスト
6. 統合テスト

## まとめ

本仕様書は型安全化システムの全分岐100%カバレッジを目指す包括的単体テスト仕様です。各テストケースは独立性を保ち、再現可能で自動化可能な設計となっています。継続的インテグレーション環境での実行を前提とし、品質ゲートとしての機能を果たします。