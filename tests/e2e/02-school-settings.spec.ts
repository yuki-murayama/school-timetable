/**
 * 02-хнжцабшинхоЪчобчРЖE2EуГЖуВ╣уГИ
 *
 * чЬЯуБоE2EуГЖуВ╣уГИя╝ЪуГЦуГйуВжуВ╢цУНф╜ЬуБлуВИуВЛхнжцабшинхоЪцйЯшГ╜уБочв║шкН
 * - уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБ╕уБоуГКуГУуВ▓уГ╝уВ╖уГзуГ│
 * - хЯ║цЬмшинхоЪуВ┐уГЦуБзуБохнжцабшинхоЪхдЙцЫ┤
 * - шинхоЪхАдуБоф┐ЭхнШуГ╗цЫ┤цЦ░чв║шкН
 * - шинхоЪхАдуБоц░╕ч╢ЪхМЦчв║шкН
 */

import { test } from '@playwright/test'
import { createErrorMonitor } from './utils/error-monitor'

// шкНши╝чК╢цЕЛуБпPlaywrightшинхоЪуБзшЗкхЛХчобчРЖуБХуВМуВЛ

// уГЖуВ╣уГИчФиуБохнжцабшинхоЪуГЗуГ╝уВ┐
const generateSchoolSettingsTestData = () => {
  const timestamp = Date.now()
  return {
    grade1Classes: 4,
    grade2Classes: 5,
    grade3Classes: 3,
    grade4Classes: 2,
    grade5Classes: 2,
    grade6Classes: 2,
    dailyPeriods: 6,
    saturdayPeriods: 4,
    testId: `school_test_${timestamp}`,
  }
}

test.describe('ЁЯПл хнжцабшинхоЪчобчРЖE2EуГЖуВ╣уГИ', () => {
  test('хнжцабхЯ║цЬмшинхоЪуБохдЙцЫ┤уБиф┐ЭхнШ', async ({ page }) => {
    const testData = generateSchoolSettingsTestData()
    console.log('ЁЯЪА хнжцабшинхоЪE2EуГЖуВ╣уГИщЦЛхзЛ')

    // уВиуГйуГ╝чЫгшжЦуБошинхоЪ
    const errorMonitor = createErrorMonitor(page, 'хнжцабхЯ║цЬмшинхоЪуБохдЙцЫ┤уБиф┐ЭхнШ')

    // Step 1: уГбуВдуГ│чФ╗щЭвуБлуВвуВпуВ╗уВ╣
    console.log('ЁЯУН Step 1: уГбуВдуГ│чФ╗щЭвуБ╕уБоуВвуВпуВ╗уВ╣')
    const baseURL = process.env.PLAYWRIGHT_BASE_URL || 'http://localhost:5174'
    await page.goto(baseURL)
    await page.waitForLoadState('networkidle')

    // шкНши╝чК╢цЕЛуБочв║шкН
    console.log('ЁЯУН шкНши╝чК╢цЕЛуБочв║шкН')
    const isLoginPage =
      (await page.locator('input[type="email"], input[type="password"]').count()) > 0
    if (isLoginPage) {
      console.log('ЁЯФН уГнуВ░уВдуГ│чФ╗щЭвуБМшбичд║уБХуВМуБ╛уБЧуБЯуАВшкНши╝уВТхоЯшбМуБЧуБ╛уБЩуАВ')

      // уГнуВ░уВдуГ│хЗжчРЖ
      await page.fill('input[type="email"]', 'test@school.local')
      await page.fill('input[type="password"]', 'password123')
      await page.click('button[type="submit"]:has-text("уГнуВ░уВдуГ│")')

      // шкНши╝хоМф║ЖуВТх╛ЕцйЯ
      await page.waitForTimeout(3000)
      await page.waitForLoadState('networkidle')
      console.log('тЬЕ цЙЛхЛХшкНши╝хоМф║Ж')
    } else {
      console.log('тЬЕ цЧвуБлшкНши╝ц╕ИуБ┐уБзуБЩ')
    }

    // Step 2: уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБ╕уБощБ╖чз╗
    console.log('ЁЯУН Step 2: уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБ╕уБощБ╖чз╗')

    // уВ╡уВдуГЙуГРуГ╝уБ╛уБЯуБпуГКуГУуВ▓уГ╝уВ╖уГзуГ│уБоуГЗуГ╝уВ┐чЩ╗щМ▓уГЬуВ┐уГ│уВТцОвуБЩ
    const dataRegistrationButtons = [
      'button:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓")',
      'a:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓")',
      '[href*="data"]',
      'nav button:has-text("уГЗуГ╝уВ┐")',
      '[role="button"]:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓")',
    ]

    let navigationSuccess = false
    for (const selector of dataRegistrationButtons) {
      const element = page.locator(selector)
      if ((await element.count()) > 0) {
        console.log(`тЬЕ уГЗуГ╝уВ┐чЩ╗щМ▓уГЬуВ┐уГ│чЩ║шжЛ: ${selector}`)
        await element.first().click()
        await page.waitForTimeout(1000)
        navigationSuccess = true
        break
      }
    }

    if (!navigationSuccess) {
      await page.screenshot({ path: 'test-results/data-registration-not-found.png' })
      throw new Error('уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБ╕уБощБ╖чз╗уГЬуВ┐уГ│уБМшжЛуБдуБЛуВКуБ╛уБЫуВУ')
    }

    // уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБошбичд║чв║шкН
    const dataPageElements = [
      '[role="tablist"]',
      'button:has-text("хЯ║цЬмшинхоЪ")',
      'h1:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓")',
      '.tabs-list',
    ]

    let dataPageLoaded = false
    for (const selector of dataPageElements) {
      if ((await page.locator(selector).count()) > 0) {
        console.log(`тЬЕ уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвчв║шкН: ${selector}`)
        dataPageLoaded = true
        break
      }
    }

    if (!dataPageLoaded) {
      await page.screenshot({ path: 'test-results/data-page-not-loaded.png' })
      throw new Error('уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБМцнгуБЧуБПшбичд║уБХуВМуБ╛уБЫуВУуБзуБЧуБЯ')
    }

    // Step 3: хЯ║цЬмшинхоЪуВ┐уГЦуБочв║шкНуГ╗щБ╕цКЮ
    console.log('ЁЯУН Step 3: хЯ║цЬмшинхоЪуВ┐уГЦуБощБ╕цКЮ')

    const basicSettingsTab = page.locator(
      'button:has-text("хЯ║цЬмшинхоЪ"), [role="tab"]:has-text("хЯ║цЬмшинхоЪ")'
    )

    if ((await basicSettingsTab.count()) > 0) {
      await basicSettingsTab.first().click()
      await page.waitForTimeout(500)
      console.log('тЬЕ хЯ║цЬмшинхоЪуВ┐уГЦуВТуВпуГкуГГуВп')
    } else {
      console.log('тД╣я╕П хЯ║цЬмшинхоЪуВ┐уГЦуБМшжЛуБдуБЛуВЙуБкуБДя╝ИцЧвуБлщБ╕цКЮц╕ИуБ┐уБохПпшГ╜цАзя╝Й')
    }

    // Step 4: хнжцабшинхоЪуГХуВйуГ╝уГауБочв║шкНуБихЕехКЫ
    console.log('ЁЯУН Step 4: хнжцабшинхоЪуГХуВйуГ╝уГауБохЕехКЫ')

    // хРДхнжх╣┤уБоуВпуГйуВ╣цХ░шинхоЪ
    const gradeInputs = [
      { grade: 1, value: testData.grade1Classes },
      { grade: 2, value: testData.grade2Classes },
      { grade: 3, value: testData.grade3Classes },
      { grade: 4, value: testData.grade4Classes },
      { grade: 5, value: testData.grade5Classes },
      { grade: 6, value: testData.grade6Classes },
    ]

    for (const { grade, value } of gradeInputs) {
      // цзШуАЕуБкуВ╗уГмуВпуВ┐уГ╝уГСуВ┐уГ╝уГ│уВТшйжшбМ
      const inputSelectors = [
        `input[name="grade${grade}Classes"]`,
        `input[name*="grade${grade}"]`,
        `input[id*="grade${grade}"]`,
        `input[placeholder*="${grade}х╣┤"]`,
        `[data-testid*="grade${grade}"]`,
      ]

      let inputFound = false
      for (const selector of inputSelectors) {
        const input = page.locator(selector)
        if ((await input.count()) > 0) {
          await input.first().clear()
          await input.first().fill(value.toString())
          console.log(`тЬЕ ${grade}х╣┤чФЯуВпуГйуВ╣цХ░шинхоЪ: ${value}`)
          inputFound = true
          break
        }
      }

      if (!inputFound) {
        console.log(`тЪая╕П ${grade}х╣┤чФЯуБоуВпуГйуВ╣цХ░хЕехКЫцмДуБМшжЛуБдуБЛуВКуБ╛уБЫуВУ`)
      }
    }

    // 1цЧеуБоцОИценцЩВщЦУцХ░шинхоЪ
    const dailyPeriodsSelectors = [
      'input[name="dailyPeriods"]',
      'input[name*="daily"]',
      'input[id*="daily"]',
      'input[placeholder*="1цЧе"]',
    ]

    for (const selector of dailyPeriodsSelectors) {
      const input = page.locator(selector)
      if ((await input.count()) > 0) {
        await input.first().clear()
        await input.first().fill(testData.dailyPeriods.toString())
        console.log(`тЬЕ 1цЧеуБоцОИценцЩВщЦУцХ░шинхоЪ: ${testData.dailyPeriods}`)
        break
      }
    }

    // хЬЯцЫЬцЧеуБоцОИценцЩВщЦУцХ░шинхоЪ
    const saturdayPeriodsSelectors = [
      'input[name="saturdayPeriods"]',
      'input[name*="saturday"]',
      'input[id*="saturday"]',
      'input[placeholder*="хЬЯцЫЬ"]',
    ]

    for (const selector of saturdayPeriodsSelectors) {
      const input = page.locator(selector)
      if ((await input.count()) > 0) {
        await input.first().clear()
        await input.first().fill(testData.saturdayPeriods.toString())
        console.log(`тЬЕ хЬЯцЫЬцЧеуБоцОИценцЩВщЦУцХ░шинхоЪ: ${testData.saturdayPeriods}`)
        break
      }
    }

    // Step 5: шинхоЪуБоф┐ЭхнШ
    console.log('ЁЯУН Step 5: шинхоЪуБоф┐ЭхнШ')

    const saveButtons = [
      'button:has-text("ф┐ЭхнШ")',
      'button:has-text("цЫ┤цЦ░")',
      'button:has-text("Save")',
      'button[type="submit"]',
      '[data-testid*="save"]',
    ]

    let saveSuccess = false
    for (const selector of saveButtons) {
      const button = page.locator(selector)
      if ((await button.count()) > 0) {
        console.log(`тЬЕ ф┐ЭхнШуГЬуВ┐уГ│чЩ║шжЛ: ${selector}`)
        await button.first().click()
        await page.waitForTimeout(2000)
        saveSuccess = true
        break
      }
    }

    if (!saveSuccess) {
      console.log('тЪая╕П ф┐ЭхнШуГЬуВ┐уГ│уБМшжЛуБдуБЛуВКуБ╛уБЫуВУ')
    }

    // Step 6: ф┐ЭхнШцИРхКЯуБочв║шкН
    console.log('ЁЯУН Step 6: ф┐ЭхнШцИРхКЯуБочв║шкН')

    // цИРхКЯуГбуГГуВ╗уГ╝уВ╕уБ╛уБЯуБпщАЪчЯеуБочв║шкН
    const successMessages = [
      'text="ф┐ЭхнШуБЧуБ╛уБЧуБЯ"',
      'text="цЫ┤цЦ░уБЧуБ╛уБЧуБЯ"',
      'text="ф┐ЭхнШхоМф║Ж"',
      '[role="alert"]:has-text("цИРхКЯ")',
      '.toast:has-text("ф┐ЭхнШ")',
      '.notification:has-text("ф┐ЭхнШ")',
    ]

    for (const selector of successMessages) {
      if ((await page.locator(selector).count()) > 0) {
        console.log(`тЬЕ ф┐ЭхнШцИРхКЯуГбуГГуВ╗уГ╝уВ╕чв║шкН: ${selector}`)
        break
      }
    }

    // Step 7: шинхоЪхАдуБоц░╕ч╢ЪхМЦчв║шкНя╝ИуГЪуГ╝уВ╕уГкуГнуГ╝уГЙх╛МуБохАдчв║шкНя╝Й
    console.log('ЁЯУН Step 7: шинхоЪхАдуБоц░╕ч╢ЪхМЦчв║шкН')

    await page.reload()
    await page.waitForLoadState('networkidle')
    await page.waitForTimeout(1000)

    // хЯ║цЬмшинхоЪуВ┐уГЦуВТхЖНх║жщБ╕цКЮя╝Их┐ЕшжБуБкха┤хРИя╝Й
    const basicSettingsTabAfterReload = page.locator(
      'button:has-text("хЯ║цЬмшинхоЪ"), [role="tab"]:has-text("хЯ║цЬмшинхоЪ")'
    )
    if ((await basicSettingsTabAfterReload.count()) > 0) {
      await basicSettingsTabAfterReload.first().click()
      await page.waitForTimeout(500)
    }

    // шинхоЪхАдуБМф┐ЭцМБуБХуВМуБжуБДуВЛуБЛчв║шкН
    const grade1Input = page.locator('input[name="grade1Classes"], input[name*="grade1"]').first()
    if ((await grade1Input.count()) > 0) {
      const currentValue = await grade1Input.inputValue()
      if (currentValue === testData.grade1Classes.toString()) {
        console.log('тЬЕ шинхоЪхАдуБоц░╕ч╢ЪхМЦчв║шкНцИРхКЯ')
      } else {
        console.log(
          `тЪая╕П шинхоЪхАдуБМф┐ЭцМБуБХуВМуБжуБДуБ╛уБЫуВУуАВцЬЯх╛ЕхАд: ${testData.grade1Classes}, хоЯщЪЫуБохАд: ${currentValue}`
        )
      }
    }

    // цЬАч╡ВуВ╣уВпуГкуГ╝уГ│уВ╖уГзуГГуГИ
    await page.screenshot({ path: 'test-results/school-settings-success.png' })

    // уВиуГйуГ╝чЫгшжЦч╡Вф║ЖуБиуГмуГЭуГ╝уГИчФЯцИР
    errorMonitor.finalize()

    console.log('тЬЕ хнжцабшинхоЪE2EуГЖуВ╣уГИхоМф║Ж')
  })

  test('хнжцабшинхоЪуБохИЭцЬЯхАдчв║шкН', async ({ page }) => {
    console.log('ЁЯЪА хнжцабшинхоЪхИЭцЬЯхАдчв║шкНуГЖуВ╣уГИщЦЛхзЛ')

    // уВиуГйуГ╝чЫгшжЦуБошинхоЪя╝ИуГЖуВ╣уГИуВ▒уГ╝уВ╣цпОуБлуВпуГкуГ╝уГ│уБкчК╢цЕЛуБзщЦЛхзЛя╝Й
    const errorMonitor = createErrorMonitor(page, 'хнжцабшинхоЪуБохИЭцЬЯхАдчв║шкН')

    const baseURL = process.env.PLAYWRIGHT_BASE_URL || 'http://localhost:5174'
    await page.goto(baseURL)
    await page.waitForLoadState('networkidle')

    // уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБлщБ╖чз╗
    const dataButton = page
      .locator('button:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓"), a:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓")')
      .first()
    if ((await dataButton.count()) > 0) {
      await dataButton.click()
      await page.waitForTimeout(1000)
    }

    // хЯ║цЬмшинхоЪуВ┐уГЦуВТщБ╕цКЮ
    const basicTab = page
      .locator('button:has-text("хЯ║цЬмшинхоЪ"), [role="tab"]:has-text("хЯ║цЬмшинхоЪ")')
      .first()
    if ((await basicTab.count()) > 0) {
      await basicTab.click()
      await page.waitForTimeout(500)
    }

    // хРДхЕехКЫцмДуБохИЭцЬЯхАдуВТчв║шкН
    const inputFields = [
      { name: 'grade1Classes', label: '1х╣┤чФЯуВпуГйуВ╣цХ░' },
      { name: 'grade2Classes', label: '2х╣┤чФЯуВпуГйуВ╣цХ░' },
      { name: 'grade3Classes', label: '3х╣┤чФЯуВпуГйуВ╣цХ░' },
      { name: 'dailyPeriods', label: '1цЧеуБоцОИценцЩВщЦУцХ░' },
      { name: 'saturdayPeriods', label: 'хЬЯцЫЬцЧеуБоцОИценцЩВщЦУцХ░' },
    ]

    for (const { name, label } of inputFields) {
      const input = page.locator(`input[name="${name}"]`).first()
      if ((await input.count()) > 0) {
        const value = await input.inputValue()
        console.log(`ЁЯУК ${label}: ${value}`)
      }
    }

    await page.screenshot({ path: 'test-results/school-settings-initial.png' })

    // уВиуГйуГ╝чЫгшжЦч╡Вф║ЖуБиуГмуГЭуГ╝уГИчФЯцИР
    errorMonitor.finalize()

    console.log('тЬЕ хнжцабшинхоЪхИЭцЬЯхАдчв║шкНуГЖуВ╣уГИхоМф║Ж')
  })

  test('цЬмчХкчТ░хвГуГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБзуБоуВ╡уГ╝уГРуГ╝хЖЕщГиуВиуГйуГ╝цдЬчЯеуГЖуВ╣уГИ', async ({ page }) => {
    console.log('ЁЯЪА цЬмчХкчТ░хвГуВ╡уГ╝уГРуГ╝хЖЕщГиуВиуГйуГ╝цдЬчЯеуГЖуВ╣уГИщЦЛхзЛ')

    // х╝╖хМЦуБХуВМуБЯуВиуГйуГ╝уГвуГЛуВ┐уГкуГ│уВ░уВТшинхоЪ
    const errorMonitor = createErrorMonitor(page, 'цЬмчХкчТ░хвГуГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуВиуГйуГ╝цдЬчЯе')

    // цЬмчХкчТ░хвГURLуБ╛уБЯуБпуГЖуВ╣уГИчТ░хвГURLуВТф╜┐чФи
    const baseURL =
      process.env.PLAYWRIGHT_BASE_URL || process.env.E2E_BASE_URL || 'http://localhost:5174'

    console.log(`ЁЯМР уГЖуВ╣уГИхп╛ш▒бURL: ${baseURL}`)
    console.log('ЁЯФН уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБзуБоуВ╡уГ╝уГРуГ╝хЖЕщГиуВиуГйуГ╝цдЬчЯеуВТщЦЛхзЛуБЧуБ╛уБЩ...')

    // цЬмчХкчТ░хвГуБочЙ╣хоЪуВиуГйуГ╝уГСуВ┐уГ╝уГ│уВТчЫгшжЦуБЩуВЛшй│ч┤░уБкуГкуВ╣уГКуГ╝уВТш┐╜хКа
    let tokenErrorDetected = false
    let serverErrorDetected = false
    let settingsErrorDetected = false

    // уГНуГГуГИуГпуГ╝уВпх┐ЬчнФуБочЫгшжЦ
    page.on('response', response => {
      const url = response.url()
      const status = response.status()

      if (url.includes('/api/school/')) {
        console.log(`ЁЯУб хнжцабщЦвщАгAPIх┐ЬчнФ: ${response.request().method()} ${url} - Status: ${status}`)

        if (status >= 500) {
          console.error(`ЁЯЪи хнжцабAPI уВ╡уГ╝уГРуГ╝хЖЕщГиуВиуГйуГ╝цдЬхЗ║: ${url} - Status: ${status}`)
          serverErrorDetected = true
        }
      }
    })

    // уВ│уГ│уВ╜уГ╝уГлуГбуГГуВ╗уГ╝уВ╕уБошй│ч┤░чЫгшжЦ
    page.on('console', msg => {
      const text = msg.text()

      if (text.includes('Invalid or expired token') || text.includes('Token validation failed')) {
        console.error(`ЁЯФР шкНши╝уГИуГ╝уВпуГ│уВиуГйуГ╝цдЬхЗ║: ${text}`)
        tokenErrorDetected = true
      }

      if (text.includes('шинхоЪшкнуБ┐ш╛╝уБ┐уВиуГйуГ╝') || text.includes('уГРуГГуВпуВиуГ│уГЙAPIуБМ500уВиуГйуГ╝')) {
        console.error(`тЪЩя╕П шинхоЪшкнуБ┐ш╛╝уБ┐уВиуГйуГ╝цдЬхЗ║: ${text}`)
        settingsErrorDetected = true
      }

      if (msg.type() === 'error') {
        console.error(`ЁЯФе уГЦуГйуВжуВ╢уВ│уГ│уВ╜уГ╝уГлуВиуГйуГ╝: ${text}`)
      }
    })

    try {
      // Step 1: цЬмчХкчТ░хвГуБлуВвуВпуВ╗уВ╣
      console.log('ЁЯУН Step 1: цЬмчХкчТ░хвГуБлуВвуВпуВ╗уВ╣')
      await page.goto(baseURL, { waitUntil: 'networkidle', timeout: 30000 })

      // хИЭцЬЯуГнуГ╝уГЙх╛МуБочК╢цЕЛчв║шкН
      await page.waitForTimeout(2000)
      const initialStats = errorMonitor.getStats()
      console.log(`ЁЯУК хИЭцЬЯуГнуГ╝уГЙх╛МуБоуВиуГйуГ╝ч╡▒шиИ: ${JSON.stringify(initialStats)}`)

      // Step 2: уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвя╝ИхЯ║цЬмцГЕха▒я╝ЙуБ╕уБоуГКуГУуВ▓уГ╝уВ╖уГзуГ│
      console.log('ЁЯУН Step 2: уГЗуГ╝уВ┐чЩ╗щМ▓чФ╗щЭвуБ╕уБощБ╖чз╗')

      const dataRegistrationButtons = [
        'button:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓")',
        'a:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓")',
        '[href*="data"]',
        'nav button:has-text("уГЗуГ╝уВ┐")',
        '[role="button"]:has-text("уГЗуГ╝уВ┐чЩ╗щМ▓")',
      ]

      let navigationSuccess = false
      for (const selector of dataRegistrationButtons) {
        const element = page.locator(selector)
        if ((await element.count()) > 0) {
          console.log(`тЬЕ уГЗуГ╝уВ┐чЩ╗щМ▓уГЬуВ┐уГ│чЩ║шжЛ: ${selector}`)
          await element.first().click()
          await page.waitForTimeout(2000) // APIхС╝уБ│хЗ║уБЧуВТх╛ЕуБд
          navigationSuccess = true
          break
        }
      }

      if (!navigationSuccess) {
        console.log('ЁЯФН чЫ┤цОеURLщБ╖чз╗уВТшйжшбМ...')
        await page.goto(`${baseURL}/#/school-settings`, {
          waitUntil: 'networkidle',
          timeout: 30000,
        })
      }

      // Step 3: хЯ║цЬмшинхоЪуВ┐уГЦуБощБ╕цКЮуБиAPIхС╝уБ│хЗ║уБЧчЫгшжЦ
      console.log('ЁЯУН Step 3: хЯ║цЬмшинхоЪуВ┐уГЦуБощБ╕цКЮ')

      const basicSettingsTab = page.locator(
        'button:has-text("хЯ║цЬмшинхоЪ"), [role="tab"]:has-text("хЯ║цЬмшинхоЪ")'
      )

      if ((await basicSettingsTab.count()) > 0) {
        await basicSettingsTab.first().click()
        await page.waitForTimeout(3000) // шинхоЪуГЗуГ╝уВ┐уГнуГ╝уГЙуБоуБЯуВБуБоAPIхС╝уБ│хЗ║уБЧуВТх╛ЕуБд
        console.log('тЬЕ хЯ║цЬмшинхоЪуВ┐уГЦуВТуВпуГкуГГуВп - APIхС╝уБ│хЗ║уБЧчЫгшжЦф╕н')
      }

      // Step 4: уВиуГйуГ╝чЩ║чФЯуБочв║шкНуБишй│ч┤░хИЖцЮР
      console.log('ЁЯУН Step 4: уВиуГйуГ╝чЩ║чФЯчК╢ц│БуБохИЖцЮР')

      const finalStats = errorMonitor.getStats()
      console.log(`ЁЯУК цЬАч╡ВуВиуГйуГ╝ч╡▒шиИ: ${JSON.stringify(finalStats)}`)

      // уВиуГйуГ╝уГмуГЭуГ╝уГИчФЯцИРя╝Иф╛ЛхдЦуВТцКХуБТуБЪуБля╝Й
      const errorReport = errorMonitor.generateReport()

      // цЬмчХкчТ░хвГчЙ╣цЬЙуБоуВиуГйуГ╝уГСуВ┐уГ╝уГ│уВТчв║шкН
      const hasTokenError =
        errorReport.consoleErrors.some(
          error =>
            error.includes('Invalid or expired token') ||
            error.includes('Token validation failed') ||
            error.includes('Authentication failed')
        ) || tokenErrorDetected

      const hasServerError =
        errorReport.networkErrors.some(
          error => error.includes('500') || error.includes('Internal Server Error')
        ) || serverErrorDetected

      const hasSettingsError =
        errorReport.consoleErrors.some(
          error =>
            error.includes('шинхоЪшкнуБ┐ш╛╝уБ┐уВиуГйуГ╝') ||
            error.includes('уГРуГГуВпуВиуГ│уГЙAPIуБМ500уВиуГйуГ╝') ||
            error.includes('уГЗуГХуВйуГлуГИшинхоЪуВТф╜┐чФиуБЧуБ╛уБЩ')
        ) || settingsErrorDetected

      // Step 5: ч╡РцЮЬуГмуГЭуГ╝уГИуБицдЬши╝
      console.log('\nЁЯУЛ цЬмчХкчТ░хвГуВ╡уГ╝уГРуГ╝уВиуГйуГ╝цдЬчЯеч╡РцЮЬ:')
      console.log(`ЁЯФР шкНши╝уГИуГ╝уВпуГ│уВиуГйуГ╝: ${hasTokenError ? 'тЬЕ цдЬхЗ║' : 'тЭМ цЬкцдЬхЗ║'}`)
      console.log(`ЁЯЪи уВ╡уГ╝уГРуГ╝хЖЕщГиуВиуГйуГ╝: ${hasServerError ? 'тЬЕ цдЬхЗ║' : 'тЭМ цЬкцдЬхЗ║'}`)
      console.log(`тЪЩя╕П шинхоЪшкнуБ┐ш╛╝уБ┐уВиуГйуГ╝: ${hasSettingsError ? 'тЬЕ цдЬхЗ║' : 'тЭМ цЬкцдЬхЗ║'}`)

      if (hasTokenError || hasServerError || hasSettingsError) {
        console.log('\nЁЯОп цЬмчХкчТ░хвГуБоуВ╡уГ╝уГРуГ╝хЖЕщГиуВиуГйуГ╝уБМцнгх╕╕уБлцдЬчЯеуБХуВМуБ╛уБЧуБЯя╝Б')
        console.log('ЁЯФз ф╗еф╕ЛуБоуВиуГйуГ╝уБМцдЬхЗ║уБХуВМуБ╛уБЧуБЯ:')

        if (hasTokenError) {
          console.log('   ЁЯФР шкНши╝уГИуГ╝уВпуГ│уВиуГйуГ╝ - JWTцЬЯщЩРхИЗуВМуБ╛уБЯуБпчДбхК╣уГИуГ╝уВпуГ│')
        }

        if (hasServerError) {
          console.log('   ЁЯЪи уВ╡уГ╝уГРуГ╝хЖЕщГиуВиуГйуГ╝ - HTTP 500х┐ЬчнФ')
        }

        if (hasSettingsError) {
          console.log('   тЪЩя╕П шинхоЪшкнуБ┐ш╛╝уБ┐уВиуГйуГ╝ - уГРуГГуВпуВиуГ│уГЙAPIщАЪф┐буВиуГйуГ╝')
        }

        console.log('\nЁЯТб уБУуВМуВЙуБоуВиуГйуГ╝уБпцЬмчХкчТ░хвГуБохХПщбМуВТчд║уБЧуБжуБДуБ╛уБЩуАВ')
        console.log('   уВвуГЧуГкуВ▒уГ╝уВ╖уГзуГ│ф┐оцнгуБ╛уБЯуБпуВ╡уГ╝уГРуГ╝хп╛х┐ЬуБМх┐ЕшжБуБзуБЩуАВ')

        // цЬмчХкчТ░хвГуБоуВиуГйуГ╝цдЬчЯеуБМчЫочЪДуБкуБоуБзуАБуГЖуВ╣уГИшЗкф╜УуБпцИРхКЯуБиуБЧуБжцЙ▒уБЖ
      } else {
        console.log('\nЁЯУ▒ чП╛хЬиуБоцЬмчХкчТ░хвГуБзуВ╡уГ╝уГРуГ╝хЖЕщГиуВиуГйуГ╝уБпцдЬхЗ║уБХуВМуБ╛уБЫуВУуБзуБЧуБЯ')
        console.log('   уВ╖уВ╣уГЖуГауБМцнгх╕╕уБлхЛХф╜ЬуБЧуБжуБДуВЛхПпшГ╜цАзуБМуБВуВКуБ╛уБЩуАВ')
      }
    } catch (error) {
      console.error('\nтЭМ уГЖуВ╣уГИхоЯшбМф╕нуБлуВиуГйуГ╝уБМчЩ║чФЯуБЧуБ╛уБЧуБЯ:', error.message)

      // уГЖуВ╣уГИхоЯшбМуВиуГйуГ╝уБзуВВуВиуГйуГ╝чЫгшжЦуГмуГЭуГ╝уГИуБпчФЯцИР
      const errorReport = errorMonitor.generateReport()
      console.log('\nЁЯУК уГЖуВ╣уГИхоЯшбМуВиуГйуГ╝цЩВуБоуВиуГйуГ╝уГмуГЭуГ╝уГИ:')
      console.log(`   уВ│уГ│уВ╜уГ╝уГлуВиуГйуГ╝: ${errorReport.consoleErrors.length}ф╗╢`)
      console.log(`   уГНуГГуГИуГпуГ╝уВпуВиуГйуГ╝: ${errorReport.networkErrors.length}ф╗╢`)
      console.log(`   уГЪуГ╝уВ╕уВиуГйуГ╝: ${errorReport.pageErrors.length}ф╗╢`)

      // уГЖуВ╣уГИхд▒цХЧуБиуБЧуБжцЙ▒уБЖ
      throw error
    }

    console.log('\nтЬЕ цЬмчХкчТ░хвГуВ╡уГ╝уГРуГ╝уВиуГйуГ╝цдЬчЯеуГЖуВ╣уГИхоМф║Ж')
  })
})
